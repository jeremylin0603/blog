# æ€æ¨£ç®—ä¸€å€‹å­—

## å­—å…ƒç¸½è¡¨ - Unicode

1. ä¸–ç•Œä¸Šå¹¾ä¹å¤§éƒ¨åˆ†çš„å­—å…ƒï¼ŒåŒ…å« emojiï¼Œéƒ½è¢«æ¶µè“‹åœ¨ Unicode ç·¨ç¢¼åº•ä¸‹ï¼Œä¹Ÿå°±æ˜¯åœ¨ Unicode é€™å¼µè¡¨ä¸­ï¼Œæ¯å€‹å­—éƒ½æœ‰ä¸€å€‹ç¨ç«‹çš„ id(çµ„åˆå­—ä¾‹å¤–ï¼Œå¾ŒçºŒè£œå……)

2. Unicode ç”¨ 17 çµ„ä¾åºçš„`å¹³é¢(Plant)`ä¾†å¤§è‡´å€åˆ†ä¸åŒæ„åœ–çš„æ–‡å­—ï¼Œå¾ 0 è™Ÿå¹³é¢é–‹å§‹ï¼Œç›´åˆ° 16 è™Ÿå¹³é¢ã€‚ä¾‹å¦‚ç¬¬ 0 å¹³é¢ç‚ºåŸºæœ¬æ–‡å­—ï¼ˆä¸­è‹±æ—¥éŸ“æ•¸å­—...ï¼‰ã€ç¬¬ 1 å¹³é¢ç‚ºå¹¾ä¹å¤±å‚³çš„å¤æ–‡å’Œæ•¸å­¸ç¬¦è™Ÿã€éŸ³ç¬¦ã€emojiï¼Œè«¸å¦‚æ­¤é¡æ¯å€‹å¹³é¢çš„ç·¨ç¢¼éƒ½æ¶µè“‹äº†ä¸åŒæ„æ€çš„æ–‡å­—

3. èˆ‰ä¾‹ï¼Œ0 è™Ÿå¹³é¢çš„ç¯„åœç‚º 0000 ~ FFFFï¼Œ1 è™Ÿå¹³é¢çš„ç¯„åœç‚º 10000 ~ 1FFFFã€‚  
   å…¶ä¸­å¹³é¢ 0ï¼Œè‹±æ–‡å­—æ¯ A çš„ä»£è™Ÿç‚º `U+0041`ï¼Œä¸­æ–‡æ•¸å­— ä¸€ çš„ä»£è™Ÿç‚º `U+4E00`  
   å¹³é¢ 1ï¼Œ'ğŸ˜€' çš„ä»£è™Ÿç‚º `U+1F600`

[wiki - Unicode å­—å…ƒå¹³é¢å°æ˜ ](https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84)

## å¾ä»£è™Ÿåˆ°è¨ˆç®—æ©Ÿ

1. æ¯å€‹å­—å…ƒåœ¨ Unicode ä¸­éƒ½æœ‰ç‰¹æ®Šçš„ä»£è™Ÿï¼Œä¾‹å¦‚è‹±æ–‡ 'a' Unicode ç·¨ç¢¼ç‚º `U+0061`ï¼Œä½† Unicode åªè² è²¬å®šç¾©æ¯å€‹æ–‡å­—çš„ç·¨è™Ÿï¼Œä¸¦ä¸è² è²¬é€™äº›æ–‡å­—åœ¨è¨ˆç®—æ©Ÿä¸­å¦‚ä½•å­˜å„²æˆ–æ˜¯å¦‚ä½•å‚³è¼¸ï¼Œå› æ­¤ç‚ºäº†æœå‹™è¨ˆç®—æ©Ÿå‚³è¼¸å’Œå„²å­˜ï¼Œè¡ä¼¸å‡ºå…©å¤§å¸¸è¦‹çš„ç·¨ç¢¼æ ¼å¼ UTF-8 & UTF-16ã€‚

## UTF-8 vs UTF-16

1. UTF-8 çš„ç³»çµ±ä¸­ï¼Œä½¿ç”¨ 1 ~ 4 å€‹ byte ä¾†è¡¨é”ä¸€å€‹ char

```js
const utf8_A = new TextEncoder().encode('A')
console.log(utf8_A) // Uint8Array [ 65 ] --> 1 byte (0x41)

const utf8_smile = new TextEncoder().encode('ğŸ˜Š')
console.log(utf8_smile) // Uint8Array [ 240, 159, 152, 138 ] --> 4 bytes (0xF0 0x9F 0x98 0x8A)
```

> UTF-8 å­—å…ƒæ•¸é›–æ˜¯å‹•æ…‹çš„ï¼Œä½†æ˜¯å¯ä»¥ç„¡ç¸«å°‡å­—å…ƒé€£æ¥åœ¨ä¸€èµ·ï¼Œåˆ¤æ–·çš„ä¾æ“šå°±æ˜¯æ¯ä¸€çµ„ UTF-8 å­—å…ƒçš„ç¬¬ä¸€å€‹å­—çš„`æœ€é«˜ä½`ã€‚  
> èˆ‰ä¾‹ `A` çš„åå…­é€²åˆ¶ç‚º `0x41` è½‰ç‚ºäºŒé€²åˆ¶å¾Œç‚º `1000001`ï¼Œ`æœ€é«˜ä½` çœ‹æœ€å·¦é‚Šçš„æ•¸å­— 1 å³ç‚ºæœ€é«˜ä½ï¼Œé€™è£¡åªæœ‰ä¸€å€‹ 1 è¡¨ç¤ºå­—å…ƒä½” 1 byteã€‚  
> èˆ‰ä¾‹ `ç¬‘æ­»` çš„åå…­é€²åˆ¶ç‚º `0xE7 0xAC 0x91 0xE6 0xAD 0xBB` ç¬¬ä¸€å€‹å­—å…ƒè½‰ç‚ºäºŒé€²åˆ¶å¾Œç‚º `11100111`ï¼Œé€™è£¡æœ€é«˜ä½æœ‰ä¸‰å€‹ 1 è¡¨ç¤ºå­—å…ƒä½” 3 byteã€‚

2. UTF-16 çš„ç³»çµ±ä¸­ï¼Œä½¿ç”¨ 2 or 4 å€‹ byte ä¾†è¡¨é”ä¸€å€‹ charï¼Œå…¶ä¸­ç•¶ 2 byte ç„¡æ³•è¡¨é”æ™‚ï¼Œï¼ˆä¹Ÿå°±æ˜¯è¶…éç¬¬ 0 å¹³é¢ã€ŒBMPã€çš„ç¯„åœ`U+0000`~`U+FFFF`ï¼‰ï¼Œæœƒæ”¹ç”¨ 4 byte ä¾†è¡¨é”ï¼Œæ­¤æ™‚é€™ 2 + 2 byte çš„çµ„åˆç¨±ç‚ºä»£ç†å°(surrogate pair)

```js
// "A" çš„ UTF-16 ç·¨ç¢¼
const utf16_A = new Uint16Array([0x0041])
console.log(utf16_A) // Uint16Array [ 65 ] => é›–ç„¶èˆ‡ UTF-8 éƒ½æ˜¯ 65ï¼Œä½†å­˜å„²æ˜¯ç”¨ 2 bytes (0x0041)

// "ğŸ˜Š" çš„ UTF-16 ç·¨ç¢¼
const utf16_smile = new Uint16Array([0xd83d, 0xde0a])
console.log(utf16_smile) // Uint16Array [ 55357, 56842 ] => 4 bytes (0xD83D 0xDE0A)
```

> `0x` é–‹é ­è¡¨é”æ•¸å­—ç‚º 16 é€²ä½ï¼Œå› æ­¤ 0x0041 => 4 \* 16 + 1 = 65

3. çµåˆå‰é¢å…©é»ï¼Œé€šå¸¸ç•¶å­˜å„²çš„è¨Šæ¯å¤§å¤šéƒ½æ˜¯ ASCII çš„å­—å…ƒæ™‚ä½¿ç”¨ UTF-8 ç·¨ç¢¼æœƒæ›´çœç©ºé–“ï¼Œåä¹‹å‰‡ç”¨ UTF-8 ç·¨ç¢¼ï¼Œé€™æ˜¯å› ç‚ºå¤§å¤š ASCII ç·¨ç¢¼å¤–çš„å­—å…ƒ UTF8 éƒ½ä½¿ç”¨ 3 å­—å…ƒï¼Œé€™ä¹Ÿæ˜¯ UTF-16 è¢«ç™¼æ˜çš„åŸå›  - ç‚ºäº†å­˜å„² ASCII ä»¥å¤–çš„å­—å…ƒæ›´é«˜æ•ˆã€‚

## Javascript çš„è¡¨é”èˆ‡å­—å…ƒé•·åº¦

1. åœ¨ JS ä¸­æœƒä½¿ç”¨ `\u` ç•¶å‰ç¶´ä»¥è¡¨é”ä¸€å€‹ Unicode å­—å…ƒ

```js
'ğŸ’©' === '\uD83D\uDCA9' // true
```

2. åœ¨ JS ä¸­æ˜¯ä»¥ UTF-16 ç·¨ç¢¼ä¾†åˆ¤æ–·å­—å…ƒé•·åº¦ï¼Œå› æ­¤ç•¶å­—å…ƒæ˜¯ä¸€å€‹ä»£ç†å°(surrogate pair)æ™‚ï¼Œé•·åº¦ç‚º 2

```js
'ğŸ’©'.length // 2
```

> å°æ–¼ä»£ç†å°ï¼Œå¯ä»¥ä½¿ç”¨ `Array.from` ä¾†åˆ‡åˆ†å…¶å­—ä¸²é•·åº¦

```js
'ğŸ’©'.split('').length // 2 -> å¯¦éš›ç‚º ['\uD83D', '\uDCA9'].length
Array.from('ğŸ’©').length // 1 -> æ­¤æ™‚ä¸€å€‹ä»£ç†å°ç‚ºä¸€å€‹å€¼ ["ğŸ’©"].length
```

3. åœ¨ JS ä¸­å¯ä»¥ä½¿ç”¨ `String.codePointAt()` ä¾†æŸ¥è©¢å­—å…ƒçš„ Unicode ç¢¼ä½

```js
'ğŸ’©'.codePointAt() // 128169
```

## éº»ç…©çš„ã€Œé›¶å¯¬é€£å­—(ZWJ - U+200D)ã€

1. åœ¨ emoji ç³»çµ±ä¸­ï¼Œé‚„å­˜åœ¨å„ç¨®ä¸åŒçš„ Unicode å­—å…ƒçµ„åˆæˆä¸€å€‹æ–°çš„ç¬¦è™Ÿï¼ŒåŒ…å« emoji å’Œéƒ¨åˆ†åœ‹å®¶çš„èªè¨€ï¼Œç¨±ç‚º ZWJ(Zero Width Joiner)ã€‚

2. JS åœ¨åˆ¤æ–·ä¸€å€‹ ZWJ ç¬¦è™Ÿæ™‚ï¼Œæ˜¯ä»¥ã€Œæ‰€æœ‰çµ„åˆã€ä¸‹å»åˆ¤åˆ¥çš„ï¼Œæ‰€ä»¥è¢å¹•ä¸Šçœ‹åˆ°çš„ä¸€å€‹å­—ç¬¦å°æ–¼ JS ä¾†èªªä¸¦ä¸æ˜¯ä¸€å€‹å­—ç¬¦æˆ–æ˜¯ä¸€å€‹ä»£ç†å°ï¼Œè€Œæ˜¯ã€Œä¸€ç¾¤å­—ç¬¦ã€ï¼Œ~~å› æ­¤å°æ–¼ ZWJï¼Œæ²’æœ‰ä¸€å€‹å¸¸è¦çš„åšæ³•å»åˆ¤æ–·é•·åº¦ã€‚~~(å·²æ›´æ–°åŸç”Ÿæ”¯æ´çš„æ–¹æ³•ï¼Œ[è©³è¦‹æ–‡ç« åº•éƒ¨](#update-åŸç”Ÿæ”¯æ´çš„-intl-segmenter))

3. ZWJ å°±åƒå€‹ç²˜åˆåŠ‘ï¼Œé—œéµç¢¼ä½æ˜¯`U+200D`ï¼Œå¯ä»¥æŠŠä¸åŒçš„ emoji é€£èµ·ä¾†ï¼Œä¾‹å¦‚å¥³ç”ŸåŠ ä¸Šå¸½å­å°±è®Šæˆä¸€å€‹æˆ´å¸½å­çš„å¥³ç”Ÿï¼Œ`U+200D` å°±æ˜¯é‚£å€‹åŠ è™Ÿã€‚

```js
'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿'.split('') // ['\uD83C', '\uDFF4', '\uDB40', '\uDC67', '\uDB40', '\uDC62', '\uDB40', '\uDC65', '\uDB40', '\uDC6E', '\uDB40', '\uDC67', '\uDB40', '\uDC7F']

Array.from('ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿') // ['ğŸ´', 'ó §U+200D', 'ó ¢U+E0065', 'ó ¥U+E006E', 'ó ®U+E0067', 'ó §U+E007F']
```

[Emoji Charts](https://unicode.org/emoji/charts/emoji-zwj-sequences.html)

### å­—å…ƒç¸½è¡¨ - ASCII

1. ASCII æ˜¯æœ€æ—©çš„è¨ˆç®—æ©Ÿå­—å…ƒæ¨™æº–ï¼Œåªå–®ç´”å®šç¾©äº†è‹±æ–‡ã€æ•¸å­—ã€åŸºæœ¬æ¨™é»ç¬¦è™Ÿï¼Œå’Œä¸€äº›è·³è„«å­—å…ƒï¼ŒUnicode æ˜¯å‘å¾Œç›¸å®¹ ASCII çš„ã€‚

2. å…©å¤§ç·¨ç¢¼ç³»çµ±ä¹Ÿç›¸å®¹ ASCIIï¼Œä½†æ˜¯ UTF-8 åœ¨è¡¨é”èˆ‡ ASCII ç›¸åŒçš„å­—å…ƒæ™‚ï¼Œä¸€æ¨£æ˜¯ç”¨ä¸€å€‹ byte ä¾†è¡¨é”ï¼Œèˆ‡ ASCII å®Œå…¨ç›¸ç¬¦ï¼Œå› æ­¤ UTF-8 ç›¸è¼ƒ UTF-16 æ›´å®Œæ•´çš„ç›¸å®¹ ASCIIã€‚

[WIKI-ASCII](https://zh.wikipedia.org/zh-tw/ASCII)

### URL ç·¨ç¢¼

www ç™¼å±•ä¹‹åˆï¼Œurl åªéœ€è¦ ASCII çš„ç·¨ç¢¼å°±èƒ½è¶³å¤ è¡¨é”è·¯å¾‘å’ŒæŸ¥è©¢ç­‰åŸºæœ¬éœ€æ±‚ï¼Œä½†æ˜¯éš¨è‘— www é–‹å§‹æ¨å»£åˆ°ä¸–ç•Œå„åœ°ï¼Œç‚ºäº†æ»¿è¶³éœ€æ±‚ URL ç·¨ç¢¼é–‹å§‹å…¼å®¹äº†å…¶ä»–èªç³»å’Œæ“´å±•æ›´å¤šåŠŸèƒ½ç¬¦è™Ÿã€‚

1. URL ç·¨ç¢¼åŸºæœ¬ä¸Šå°±æ˜¯æ··åˆäº† ASCII + UTF-8ï¼Œç•¶ URL ä¸­çš„å­—å…ƒè¶…å‡º ASCII çš„ç¯„åœæ™‚å°±æœƒå°‡å­—å…ƒè½‰ç‚º UTF-8 å¾Œå†æ”¹æˆ URL ç·¨ç¢¼æ ¼å¼ã€‚

2. é€å‡ºè«‹æ±‚æ™‚å¦‚ GETã€POST form ç­‰

### åƒè€ƒè³‡æ–™

[åœ¨ç¨‹å¼è£¡ç®— Emoji å­—æ•¸çš„é‚£äº›å•é¡Œ](https://medium.com/dcardlab/%E5%9C%A8%E7%A8%8B%E5%BC%8F%E8%A3%A1%E7%AE%97-emoji-%E5%AD%97%E6%95%B8%E7%9A%84%E9%82%A3%E4%BA%9B%E5%95%8F%E9%A1%8C-8e1a1170a499)

## Update åŸç”Ÿæ”¯æ´çš„ `Intl.Segmenter`

ç¾åœ¨ JS å·²ç¶“èƒ½å¤ åŸç”Ÿæ”¯æ´å”åŠ©é–‹ç™¼è€…æ›´å¥½çš„åˆ¤æ–· ZWJ æ ¼å¼çš„å­—å…ƒäº†

> NOTICE: FireFox åœ¨ 2024/04 æ‰é–‹å§‹æ”¯æ´æ­¤èªæ³•ï¼Œæ¸¬è©¦æ™‚è¦æ³¨æ„ç‰ˆæœ¬æ˜¯å¦æœ‰è·Ÿä¸Š [CanIUse](https://caniuse.com/?search=Intl.Segmenter)

```js
/**
 * ç¬¬ä¸€å€‹åƒæ•¸èƒ½å¤ æŒ‡å®šèªç³»ï¼Œé€™é‚Šæˆ‘å€‘ä¸éœ€è¦æ‰€ä»¥ç›´æ¥çµ¦ `void 0`
 * grapheme è¡¨ç¤ºå¸Œæœ›å°‡å­—ä¸²åˆ†å‰²æˆåœ–å½¢(grapheme)ï¼Œåœ–å½¢æ˜¯æŒ‡ä¸€å€‹æˆ–å¤šå€‹å­—å…ƒçµ„æˆçš„æœ€å°å–®ä½ï¼Œåœ¨é€™å€‹ä¾‹å­ä¸­æœƒå°‡ç”± ZWJ å¤šå€‹å­—å…ƒçµ„æˆçš„ emoji ç•¶æˆä¸€å€‹åœ–å½¢è™•ç†ã€‚
 */
const segmenter = new Intl.Segmenter(void 0, { granularity: 'grapheme' })

// input -> 'ğŸ‘©â€ğŸ¦°ğŸ‘©â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ğŸ³ï¸â€ğŸŒˆ'
const input = String.fromCodePoint(
  0x1f469,
  0x200d,
  0x1f9b0,
  0x1f469,
  0x200d,
  0x1f469,
  0x200d,
  0x1f466,
  0x200d,
  0x1f466,
  0x1f3f3,
  0xfe0f,
  0x200d,
  0x1f308
)

const segments = segmenter.segment(input)

const graphemes = Array.from(segments, (s) => s.segment)

console.log(graphemes)
console.log(graphemes.length) // 3
```

åˆ†äº«æˆ‘è‡ªå·±å¯«çš„ä¸€å€‹ç°¡å–®çš„ Vue3 composable utilï¼Œç›®å‰é€™æ¨£å·²ç¶“èƒ½è§£æ±ºæˆ‘è‡ªå·±æ¥­å‹™ä¸Šçš„å•é¡Œï¼Œæœªä¾†å†çœ‹æœ‰æ²’æœ‰éœ€è¦èª¿æ•´é‚„æ˜¯æ“´å±•åŠŸèƒ½

```typescript
export function useToGraphemeArray() {
  const segmenter = new Intl.Segmenter(void 0, { granularity: 'grapheme' })

  function toGraphemeArray(input: MaybeRef<string | number | null | undefined>) {
    if (!input) return []
    const segments = segmenter.segment(String(unref(input)))
    return Array.from(segments, (s) => s.segment)
  }

  return {
    toGraphemeArray
  }
}

// how to use
const { toGraphemeArray } = useToGraphemeArray()
toGraphemeArray('ğŸ‘©â€ğŸ¦°ğŸ‘©â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ğŸ³ï¸â€ğŸŒˆ').length // 3
```

[MDN Intl.Segmenter](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/Segmenter)
